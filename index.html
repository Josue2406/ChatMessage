<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat UNA – Estilo WhatsApp (sin backend de archivos)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
      :root{
        --wa-green:#075E54;
        --wa-teal:#128C7E;
        --wa-light:#DCF8C6;   /* saliente */
        --wa-incoming:#ffffff;/* entrante */
        --bg:#0b141a;
        --panel:#111b21;
        --panel-2:#202c33;
        --text:#e9edef;
        --muted:#8696a0;
        --accent:#25D366;
        --pattern: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 512 512' opacity='0.07'><defs><pattern id='p' width='64' height='64' patternUnits='userSpaceOnUse'><circle cx='2' cy='2' r='2' fill='white'/><circle cx='34' cy='34' r='1.5' fill='white'/><circle cx='60' cy='20' r='1' fill='white'/></pattern></defs><rect width='100%' height='100%' fill='url(%23p)'/></svg>");
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
        background: linear-gradient(180deg,#0b141a 0%,#222b32 100%);
        color:var(--text);
      }

      .app{height:100vh;display:flex;justify-content:center}
      .chat{width:min(100%,980px);display:flex;flex-direction:column;background:var(--panel);border-left:1px solid #1f2c33;border-right:1px solid #1f2c33}

      .chat__header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--panel-2);position:sticky;top:0;z-index:10;border-bottom:1px solid #1f2c33}
      .chat__avatar{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;font-weight:600;font-size:14px;background:#2a3942;color:#b7c3c8;user-select:none}
      .chat__room{font-weight:600}
      .chat__subtitle{font-size:12px;color:var(--muted)}
      .chat__actions{margin-left:auto;display:flex;gap:10px}
      .icon-btn{background:transparent;border:0;color:#aebac1;cursor:pointer}
      .icon-btn:active{transform:scale(.96)}

      .chat__messages{
        flex:1;overflow-y:auto;position:relative;
        background: var(--pattern) center/512px repeat;
        padding:20px 24px 16px;
      }
      .day-divider{text-align:center;margin:12px auto;width:max-content;padding:6px 12px;background:#182229;color:#b7c3c8;border-radius:999px;font-size:12px}

      .msg{max-width:70%;padding:8px 10px 6px;border-radius:14px;margin:6px 0;position:relative;box-shadow:0 1px 0 rgba(0,0,0,.15)}
      .msg.in{background:var(--wa-incoming);color:#111;margin-right:auto;border-top-left-radius:4px}
      .msg.out{background:var(--wa-light);color:#111;margin-left:auto;border-top-right-radius:4px}
      .msg__name{font-weight:600;font-size:12px;margin-bottom:2px;color:#0b5ed7}
      .msg__content{white-space:pre-wrap;word-wrap:break-word;line-height:1.35}
      .msg__meta{display:flex;align-items:center;gap:6px;justify-content:flex-end;font-size:11px;color:#667781;margin-top:2px}

      .msg img,.msg video,.msg iframe{display:block;width:100%;max-height:320px;border-radius:10px;margin:6px 0 4px;outline:1px solid rgba(0,0,0,.06)}
      .msg a{color:#0b5ed7;text-decoration:none}
      .msg a:hover{text-decoration:underline}

      .name-inline{display:flex;gap:8px;align-items:center;padding:6px 10px;color:#aebac1;font-size:12px}
      .name-inline input{background:#2a3942;border:0;border-radius:6px;padding:6px 8px;color:var(--text)}

      .chat__composer{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--panel-2);border-top:1px solid #1f2c33}
      .input-wrap{flex:1;display:flex;align-items:center;gap:10px;background:#2a3942;border-radius:8px;padding:8px 10px}
      .input-wrap input[type="text"]{flex:1;background:transparent;border:0;outline:none;color:var(--text);font-size:14px}
      .send-btn{display:grid;place-items:center;width:40px;height:40px;border-radius:999px;border:0;cursor:pointer;background:var(--accent);color:#0b141a;font-weight:700}
      .send-btn:active{transform:translateY(1px)}
      .file-input{display:none}
      .file-label{background:#2a3942;border-radius:8px;padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:pointer;color:#aebac1;border:1px dashed #344954}
      .file-label:hover{border-color:#4e6772}

      .toast{position:fixed;right:16px;bottom:16px;background:#1f2c33;color:#c5d1d6;padding:10px 12px;border-radius:8px;opacity:0;transform:translateY(6px);transition:.25s;box-shadow:0 6px 24px rgba(0,0,0,.25)}
      .toast.show{opacity:1;transform:translateY(0)}

      @media (max-width:720px){.msg{max-width:88%}.chat{border-left:0;border-right:0}}
    </style>
  </head>
  <body>
    <div class="app">
      <section class="chat" aria-label="Sala de chat">
        <header class="chat__header">
          <div class="chat__avatar" id="roomAvatar">💬</div>
          <div>
            <div class="chat__room">Chat Seguro UNA</div>
            <div class="chat__subtitle" id="subtitle">Lab 5 • Conectando…</div>
          </div>
          <div class="chat__actions">
            <label class="file-label" for="file">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21.44 11.05l-7.78 7.78a5.5 5.5 0 11-7.78-7.78l8.49-8.49a3.5 3.5 0 115 5l-8.49 8.49a1.5 1.5 0 11-2.12-2.12l7.78-7.78" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
              Adjuntar
            </label>
            <input id="file" class="file-input" type="file" accept="image/*,video/*" />
          </div>
        </header>

        <main id="messages" class="chat__messages" aria-live="polite"></main>

        <div class="name-inline">
          <label for="nombre">Tu nombre</label>
          <input id="nombre" maxlength="50" placeholder="Escribe tu nombre" />
          <span class="chip">Se guarda en este navegador</span>
        </div>

        <form class="chat__composer" id="composer" autocomplete="off">
          <div class="input-wrap">
            <input id="m" type="text" maxlength="2000" placeholder="Escribe un mensaje o pega un link (imagen/video/YouTube)" aria-label="Mensaje" />
          </div>
          <button type="submit" class="send-btn" title="Enviar" aria-label="Enviar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"/></svg>
          </button>
        </form>
      </section>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite">Conectando…</div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
      // ========== UI helpers ==========
      const toast = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200)};
      const $messages = $('#messages');
      const $name = $('#nombre');
      const $input = $('#m');
      const $subtitle = document.getElementById('subtitle');

      const me = {
        get name(){ return localStorage.getItem('chat_name') || '' },
        set name(v){ localStorage.setItem('chat_name', v || '') }
      };
      if(me.name) $name.val(me.name);

      function safe(str){
        return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }
      function autolink(text){
        const re = /(https?:\/\/[^\s"'<>\]]+)/g; // evita comillas y <>
        return (text||'').replace(re, (url)=>`<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
      }
      function formatTime(d){
        const hh = d.getHours().toString().padStart(2,'0');
        const mm = d.getMinutes().toString().padStart(2,'0');
        return `${hh}:${mm}`;
      }
      function initials(name){
        const parts = (name||'').trim().split(/\s+/);
        return (parts[0]?.[0]||'U') + (parts[1]?.[0]||'');
      }

      // ======== Detección de media por URL ========
      function isImageUrl(u){ return /\.(png|jpe?g|gif|webp|bmp|svg)(\?.*)?$/i.test(u) }
      function isVideoUrl(u){ return /\.(mp4|webm|ogg)(\?.*)?$/i.test(u) }

      // YouTube: watch?v=, youtu.be/, embed/, shorts/
      function isYouTube(u){
        return /(youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/shorts\/)/i.test(u);
      }
      function ytIdFromUrl(u){
        return (
          (u.match(/[?&]v=([\w-]{11})/) || [])[1] ||
          (u.match(/youtu\.be\/([\w-]{11})/) || [])[1] ||
          (u.match(/\/embed\/([\w-]{11})/) || [])[1] ||
          (u.match(/\/shorts\/([\w-]{11})/) || [])[1] || null
        );
      }

      function renderMediaFromUrl(text){
        const m = (text||'').match(/https?:\/\/[^\s"'<>\]]+/i);
        if(!m) return '';
        const url = m[0];

        if (isImageUrl(url)) {
          return `<img src="${safe(url)}" alt="imagen" loading="lazy">`;
        }
        if (isVideoUrl(url)) {
          return `<video src="${safe(url)}" controls preload="metadata"></video>`;
        }
        if (isYouTube(url)) {
          const id = ytIdFromUrl(url);
          if (id) {
            return `<iframe width="320" height="180"
                      src="https://www.youtube.com/embed/${id}"
                      title="YouTube" frameborder="0"
                      allowfullscreen loading="lazy"></iframe>`;
          }
        }
        return '';
      }

      // Día divisor
      let lastDayKey = '';
      function maybeInsertDayDivider(date){
        const key = date.toISOString().slice(0,10);
        if(key !== lastDayKey){
          lastDayKey = key;
          const label = new Intl.DateTimeFormat(undefined,{dateStyle:'medium'}).format(date);
          $messages.append($('<div/>',{class:'day-divider', text: label}));
        }
      }

      // ========== Socket ==========
      const socket = io();
      socket.on('connect', ()=>{ toast('🟢 Conectado'); $subtitle.textContent='Lab 5 • Conectado'; });
      socket.on('disconnect', ()=>{ toast('🔴 Desconectado'); $subtitle.textContent='Lab 5 • Desconectado'; });
      socket.on('reconnect',  ()=>{ toast('🟡 Reconectando…'); $subtitle.textContent='Lab 5 • Reconectando…'; });

      // Enviar texto
      document.getElementById('composer').addEventListener('submit', (e)=>{
        e.preventDefault();
        const name = ($name.val().trim() || 'Anónimo');
        me.name = name;
        const text = $input.val().trim();
        if(!text){ toast('Escribe un mensaje'); return; }
        const payload = { nombre: name, mensaje: text, ts: Date.now() };
        socket.emit('Evento-Mensaje-Server', JSON.stringify(payload));
        $input.val('');
      });

      // Enviar archivo local como DataURL (sin backend)
      $('#file').on('change', function(){
        const file = this.files?.[0];
        if(!file) return;

        if(file.size > 10 * 1024 * 1024){
          toast('⚠️ Archivo > 10MB. Reduce el peso.');
          this.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = (e)=>{
          const name = ($name.val().trim() || 'Anónimo');
          me.name = name;

          const isImage = file.type.startsWith('image/');
          const isVideo = file.type.startsWith('video/');

          const payload = {
            nombre: name,
            mensaje: '',
            media: {
              type: isImage ? 'image' : (isVideo ? 'video' : 'other'),
              dataUrl: e.target.result,
              mime: file.type,
              name: file.name,
              size: file.size
            },
            ts: Date.now()
          };
          socket.emit('Evento-Mensaje-Server', JSON.stringify(payload));
          toast('✅ Archivo enviado');
          $('#file').val('');
        };
        reader.readAsDataURL(file);
      });

      // Pegar/arrastrar archivos
      document.addEventListener('paste', (e)=>{
        const item = [...(e.clipboardData?.items||[])].find(i=>/^image\//.test(i.type));
        if(!item) return;
        const file = item.getAsFile();
        if(!file) return;
        const dt = new DataTransfer(); dt.items.add(file);
        const input = document.getElementById('file'); input.files = dt.files;
        $('#file').trigger('change');
      });
      const dropZone = document.getElementById('messages');
      dropZone.addEventListener('dragover', (e)=>{ e.preventDefault(); });
      dropZone.addEventListener('drop', (e)=>{
        e.preventDefault();
        const file = e.dataTransfer.files?.[0];
        if(file){ const dt = new DataTransfer(); dt.items.add(file); const input = document.getElementById('file'); input.files = dt.files; $('#file').trigger('change'); }
      });

      // Recibir y renderizar
      socket.on('Evento-Mensaje-Server', (raw)=>{
        try{
          const msg = JSON.parse(raw);
          const who = (msg.nombre||'Anónimo');
          const when = new Date(msg.ts || Date.now());
          maybeInsertDayDivider(when);

          const outgoing = me.name && who.toLowerCase() === me.name.toLowerCase();
          const bubble = document.createElement('div');
          bubble.className = `msg ${outgoing? 'out':'in'}`;

          let inner = '';
          if(!outgoing){ inner += `<div class="msg__name">${safe(who)}</div>`; }

          const rawText = msg.mensaje || '';
          // Texto seguro (escapado)
          let textPart = rawText ? `<div class="msg__content">${autolink(safe(rawText))}</div>` : '';

          // Media generada por el cliente (NO escapada)
          let mediaPart = '';
          if(msg.media?.type === 'image' && msg.media.dataUrl){
            mediaPart = `<img src="${msg.media.dataUrl}" alt="${safe(msg.media.name||'imagen')}">`;
          } else if(msg.media?.type === 'video' && msg.media.dataUrl){
            mediaPart = `<video src="${msg.media.dataUrl}" controls preload="metadata"></video>`;
          } else {
            mediaPart = renderMediaFromUrl(rawText);
          }

          // Detectar iframe pegado real o ESCAPADO (&lt;iframe) o /embed/ y ocultar el texto crudo
          const containsIframeTag = /(?:<|&lt;)\s*iframe/i.test(rawText);
          const containsEmbedUrl  = /youtube\.com\/embed\//i.test(rawText);
          if (mediaPart && (containsIframeTag || containsEmbedUrl)) {
            textPart = '';
          }

          inner += textPart + mediaPart + `<div class="msg__meta">${formatTime(when)}</div>`;
          bubble.innerHTML = inner;

          $messages.append(bubble);
          $messages.scrollTop($messages[0].scrollHeight);
        }catch(err){ console.error('Error procesando mensaje', err); toast('Error al procesar mensaje'); }
      });

      // Enter para enviar
      $input.on('keydown', (e)=>{ if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('composer').requestSubmit(); } });

      // Avatar
      const roomAvatar = document.getElementById('roomAvatar');
      function updateRoomAvatar(){ const n=(me.name||'U'); roomAvatar.textContent = initials(n).slice(0,2).toUpperCase(); }
      updateRoomAvatar(); $name.on('input', ()=>{ me.name = $name.val(); updateRoomAvatar(); });
    </script>
  </body>
</html>
